<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>فاتورة نظام مؤسسي - شركة البطل</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- html2pdf.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <!-- JsBarcode -->
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>

    <style>
        /* UI Font */
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap');

        body {
            font-family: 'Cairo', sans-serif;
            background-color: #e5e7eb;
        }

        /* --- ENTERPRISE INVOICE STYLES (A4) --- */
        .invoice-box {
            background: white;
            /* A4 dimensions: 210mm width, 297mm height */
            width: 210mm; 
            min-height: 297mm;
            padding: 15mm;
            margin: 0; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            /* System fonts for PDF reliability - Critical for Arabic support */
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #333;
            line-height: 1.4;
            box-sizing: border-box;
            position: relative;
            font-size: 14px;
        }

        /* Header Section */
        .erp-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            border-bottom: 3px solid #1a1a1a;
            padding-bottom: 20px;
            margin-bottom: 30px;
        }
        
        .company-branding h1 {
            font-size: 32px;
            font-weight: 800;
            color: #1a1a1a;
            margin-bottom: 8px;
            text-transform: uppercase;
        }

        /* Info Blocks */
        .info-section {
            display: flex;
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .info-box {
            flex: 1;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .box-header {
            background-color: #f3f4f6;
            color: #111;
            padding: 10px 15px;
            font-weight: 800;
            border-bottom: 1px solid #e5e7eb;
            font-size: 14px;
        }
        
        .box-content {
            padding: 15px;
        }

        .data-row {
            display: flex;
            margin-bottom: 10px;
            align-items: baseline;
            border-bottom: 1px dashed #f3f4f6;
            padding-bottom: 4px;
        }
        .data-row:last-child {
            border-bottom: none;
        }
        
        .data-label {
            width: 90px;
            color: #666;
            font-weight: 600;
            font-size: 13px;
        }
        .data-value {
            flex: 1;
            font-weight: 700;
            color: #000;
            font-size: 14px;
        }

        /* ERP Style Table */
        .erp-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 30px;
            font-size: 14px;
        }
        
        .erp-table th {
            background-color: #1a1a1a; /* Dark Header */
            color: white;
            padding: 12px;
            text-align: center;
            font-weight: 700;
            font-size: 14px;
            border: 1px solid #1a1a1a;
        }
        
        .erp-table td {
            padding: 15px 12px;
            border: 1px solid #e5e7eb;
            vertical-align: middle;
        }
        
        .erp-table tr:nth-child(even) {
            background-color: #f9fafb;
        }

        /* Total Section */
        .total-section {
            display: flex;
            justify-content: flex-end;
            margin-top: 20px;
        }
        
        .total-box {
            width: 50%;
            border: 2px solid #1a1a1a;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .total-row {
            display: flex;
            justify-content: space-between;
            padding: 15px 20px;
            background-color: #f3f4f6;
            font-weight: 800;
            font-size: 18px;
            color: #000;
            align-items: center;
        }

        /* Stamp Position - UPDATED SIZE */
        .stamp-container {
            margin-top: 50px;
            margin-right: 30px;
            text-align: left;
            position: relative;
            height: 200px; /* Increased height container */
        }
        
        .stamp-img { 
            width: 220px; /* Increased width from 160px */
            transform: rotate(-10deg);
            opacity: 0.9;
        }

        /* Helpers */
        .ltr { direction: ltr; display: inline-block; }
        .text-right { text-align: right; }
        .text-center { text-align: center; }
        
        /* Capture fix */
        #invoice-content {
            margin: 0; 
            transform-origin: top left;
        }

        @media print {
            body * { visibility: hidden; }
            .invoice-box, .invoice-box * { visibility: visible; }
            .invoice-box { position: absolute; left: 0; top: 0; margin: 0; padding: 0; }
            .no-print { display: none; }
            .erp-table th { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
        }
    </style>
</head>
<body>

    <div class="container mx-auto p-4 lg:p-6 flex flex-col lg:flex-row gap-6">
        
        <!-- SIDEBAR CONTROLS -->
        <div class="w-full lg:w-1/3 no-print">
            <div class="bg-white p-5 rounded shadow-sm sticky top-4 border-t-4 border-gray-800">
                <h2 class="text-lg font-bold mb-4 text-gray-800 flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                    بيانات الفاتورة
                </h2>
                
                <form id="invoiceForm" onsubmit="event.preventDefault();" class="space-y-4">
                    <!-- Client -->
                    <div class="space-y-2">
                        <label class="text-xs font-bold text-gray-500 uppercase">العميل</label>
                        <input type="text" id="customerName" placeholder="اسم العميل" class="w-full p-2 border rounded text-sm focus:ring-1 focus:ring-black" oninput="updateInvoice()">
                        <div class="flex gap-2">
                            <input type="text" id="customerNo" placeholder="رقم العميل" class="w-1/2 p-2 border rounded text-sm focus:ring-1 focus:ring-black" oninput="updateInvoice()">
                            <input type="text" id="customerPhone" placeholder="الهاتف" class="w-1/2 p-2 border rounded text-sm focus:ring-1 focus:ring-black" oninput="updateInvoice()">
                        </div>
                        <textarea id="customerAddress" rows="2" placeholder="العنوان" class="w-full p-2 border rounded text-sm focus:ring-1 focus:ring-black" oninput="updateInvoice()"></textarea>
                    </div>

                    <!-- Details -->
                    <div class="space-y-2 pt-2 border-t">
                        <label class="text-xs font-bold text-gray-500 uppercase">التفاصيل</label>
                        <input type="text" id="quantityStatement" placeholder="بيان الكمية" class="w-full p-2 border rounded text-sm focus:ring-1 focus:ring-black" oninput="updateInvoice()">
                        <div class="flex gap-2">
                            <input type="text" id="orderValue" placeholder="القيمة (مثال: 1000)" class="w-1/2 p-2 border rounded text-sm focus:ring-1 focus:ring-black" oninput="updateInvoice()">
                            <input type="date" id="invoiceDate" class="w-1/2 p-2 border rounded text-sm focus:ring-1 focus:ring-black" oninput="updateInvoice()">
                        </div>
                    </div>

                    <!-- Seal -->
                    <div class="pt-2">
                        <label class="block text-xs font-bold text-gray-500 mb-1">الختم</label>
                        <input type="file" id="sealInput" accept="image/*" class="w-full text-xs" onchange="loadSeal(event)">
                    </div>

                    <!-- Buttons -->
                    <div class="pt-4 flex gap-2">
                        <button id="downloadBtn" onclick="downloadPDF()" class="flex-1 bg-gray-900 text-white py-3 rounded shadow hover:bg-black transition font-bold text-sm">
                            حفظ PDF
                        </button>
                        <button onclick="resetForm()" class="px-4 py-3 border rounded hover:bg-gray-50 text-sm">
                            جديد
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- INVOICE PREVIEW AREA -->
        <div class="w-full lg:w-2/3 bg-gray-300 p-4 lg:p-8 rounded overflow-auto flex justify-center items-start">
            
            <div id="invoice-content" class="invoice-box">
                
                <!-- Header -->
                <div class="erp-header">
                    <div class="company-branding">
                        <h1>شركة البطل للتوريدات</h1>
                        <div style="font-size: 14px; color: #444; margin-top: 10px; line-height: 1.6;">
                            <div>سجل تجاري: <span class="ltr">428520</span></div>
                            <div>بطاقة ضريبية: <span class="ltr">741-667-773</span></div>
                            <div>مسؤول: م/ عماد | <span class="ltr">01125295004</span></div>
                        </div>
                    </div>
                    
                    <div style="text-align: left;">
                        <div class="doc-title" style="font-weight: 800; color: #1a1a1a; letter-spacing: 0; font-size: 28px;">فاتورة</div>
                        <!-- Generated Barcode -->
                        <div style="margin-top: 15px;">
                            <svg id="barcode"></svg>
                        </div>
                    </div>
                </div>

                <!-- Info Grid -->
                <div class="info-section">
                    <!-- Invoice Meta -->
                    <div class="info-box">
                        <div class="box-header">بيانات الفاتورة</div>
                        <div class="box-content">
                            <div class="data-row">
                                <span class="data-label">التاريخ:</span>
                                <span class="data-value ltr" style="text-align: right;" id="displayDate">--</span>
                            </div>
                            <div class="data-row">
                                <span class="data-label">الرقم:</span>
                                <span class="data-value ltr" style="text-align: right;"><span id="invNum">0000</span></span>
                            </div>
                             <div class="data-row">
                                <span class="data-label">الحالة:</span>
                                <span class="data-value" style="color: green;">معتمد</span>
                            </div>
                        </div>
                    </div>

                    <!-- Client Info -->
                    <div class="info-box" style="flex: 1.5;">
                        <div class="box-header">بيانات العميل</div>
                        <div class="box-content">
                            <div class="data-row">
                                <span class="data-label">الاسم:</span>
                                <span class="data-value" id="displayCustomerName" style="font-weight: 700; font-size: 16px;">--</span>
                            </div>
                             <div class="data-row">
                                <span class="data-label">رقم العميل:</span>
                                <span class="data-value" id="displayCustomerNo">--</span>
                            </div>
                            <div class="data-row">
                                <span class="data-label">الهاتف:</span>
                                <span class="data-value ltr" style="text-align: right;" id="displayCustomerPhone">--</span>
                            </div>
                            <div class="data-row">
                                <span class="data-label">العنوان:</span>
                                <span class="data-value" id="displayCustomerAddress">--</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Table -->
                <table class="erp-table">
                    <thead>
                        <tr>
                            <th style="width: 10%;">#</th>
                            <th style="width: 60%; text-align: right;">بيان الطلبية / الكمية</th>
                            <th style="width: 30%;">القيمة</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="text-center">01</td>
                            <td style="font-weight: 700; font-size: 15px;" id="displayQuantity">--</td>
                            <td class="ltr text-center" style="font-weight: 800; font-size: 16px;" id="displayOrderValueRow">--</td>
                        </tr>
                    </tbody>
                </table>

                <!-- Totals -->
                <div class="total-section">
                    <div class="total-box">
                        <div class="total-row">
                            <span>الإجمالي المستحق</span>
                            <span id="displayOrderValue" class="ltr">--</span>
                        </div>
                    </div>
                </div>

                <!-- Stamp Area -->
                <div class="stamp-container">
                     <!-- Placeholder if no stamp -->
                     <!-- Increased placeholder size to match image -->
                     <div id="sealPlaceholder" style="border: 2px dashed #bbb; width: 220px; height: 180px; border-radius: 20px; display: flex; align-items: center; justify-content: center; color: #999; font-weight: bold; transform: rotate(-5deg);">
                        مكان الختم
                    </div>
                    <img id="sealPreview" src="batal.png" onerror="this.style.display='none'; document.getElementById('sealPlaceholder').style.display='flex';" class="stamp-img" style="display: none;">
                </div>
                
                <!-- Footer -->
                <div style="position: absolute; bottom: 15mm; left: 0; width: 100%; text-align: center; font-size: 12px; color: #666; border-top: 1px solid #ddd; padding-top: 15px;">
                    تم إصدار هذه الفاتورة إلكترونياً • شركة البطل للتجارة والتوريدات • نشكركم على ثقتكم
                </div>

            </div>

        </div>
    </div>

    <script>
        const today = new Date();
        document.getElementById('invoiceDate').valueAsDate = today;
        document.getElementById('invNum').innerText = Math.floor(100000 + Math.random() * 900000);

        function generateBarcode() {
            JsBarcode("#barcode", document.getElementById('invNum').innerText, {
                format: "CODE128",
                width: 1.8,
                height: 50,
                displayValue: false,
                lineColor: "#1a1a1a"
            });
        }
        
        setTimeout(generateBarcode, 500);

        function updateInvoice() {
            const map = {
                'customerNo': 'displayCustomerNo',
                'customerName': 'displayCustomerName',
                'customerPhone': 'displayCustomerPhone',
                'customerAddress': 'displayCustomerAddress',
                'quantityStatement': 'displayQuantity'
            };

            for (let [inId, outId] of Object.entries(map)) {
                let val = document.getElementById(inId).value;
                document.getElementById(outId).innerText = val || "--";
            }

            let val = document.getElementById('orderValue').value;
            let displayVal = val || "--";
            document.getElementById('displayOrderValue').innerText = displayVal;
            document.getElementById('displayOrderValueRow').innerText = displayVal;

            let dateVal = document.getElementById('invoiceDate').value;
            if(dateVal) {
                let d = new Date(dateVal);
                document.getElementById('displayDate').innerText = d.toLocaleDateString('en-GB');
            }
        }

        function loadSeal(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.getElementById('sealPreview');
                    img.src = e.target.result;
                    img.style.display = 'block';
                    document.getElementById('sealPlaceholder').style.display = 'none';
                };
                reader.readAsDataURL(file);
            }
        }
        
        window.onload = function() {
            const img = document.getElementById('sealPreview');
            img.style.display = 'none'; 
            const tempImg = new Image();
            tempImg.src = "batal.png";
            tempImg.onload = function() {
                img.src = this.src;
                img.style.display = 'block';
                document.getElementById('sealPlaceholder').style.display = 'none';
            }
        };

        function downloadPDF() {
            const element = document.getElementById('invoice-content');
            const clientName = document.getElementById('customerName').value || 'Client';
            const btn = document.getElementById('downloadBtn');
            const originalContent = btn.innerHTML;
            
            btn.innerHTML = "جاري الحفظ...";
            btn.disabled = true;

            const opt = {
                margin: 0,
                filename: `فاتورة_${clientName}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { 
                    scale: 2, 
                    useCORS: true, 
                    scrollY: 0,
                    x: 0,
                    y: 0,
                    width: 794, 
                    windowWidth: 800 
                },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            html2pdf().set(opt).from(element).save().then(() => {
                btn.innerHTML = originalContent;
                btn.disabled = false;
            }).catch(err => {
                alert("خطأ: " + err.message);
                btn.innerHTML = originalContent;
                btn.disabled = false;
            });
        }

        function resetForm() {
            if(confirm('مسح البيانات؟')) {
                document.getElementById('invoiceForm').reset();
                document.getElementById('invoiceDate').valueAsDate = new Date();
                document.getElementById('invNum').innerText = Math.floor(100000 + Math.random() * 900000);
                generateBarcode();
                updateInvoice();
            }
        }

        updateInvoice();
    </script>
</body>
</html>
